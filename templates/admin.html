{% extends "base.html" %}
{% block content %}
<div class="main-container">
    <h2>Admin Panel: User Management</h2>
    <div id="alert-container"></div>

    <table style="width:100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <thead>
        <tr style="background: #2d3436; color: white; text-align: left;">
            <th style="padding: 15px;">ID</th>
            <th style="padding: 15px;">Username</th>
            <th style="padding: 15px;">Email</th>
            <th style="padding: 15px;">Books Count</th>
            <th style="padding: 15px;">Last Active</th>
            <th style="padding: 15px;">Role</th>
            <th style="padding: 15px;">Action</th>
        </tr>
        </thead>
        <tbody>
        {% for user in users %}
        <tr id="user-row-{{ user.id }}" style="border-bottom: 1px solid #eee;">
            <td style="padding: 15px;">{{ user.id }}</td>
            <td style="padding: 15px;">{{ user.username }}</td>
            <td style="padding: 15px;">{{ user.email }}</td>
            <td style="padding: 15px;" id="books-count-{{ user.id }}">{{ user.books|length }}</td>

            <td style="padding: 15px;">
                {% if user.last_seen %}
                {{ user.last_seen.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                Never
                {% endif %}
            </td>

            <td style="padding: 15px;">{{ 'Admin' if user.is_admin else 'User' }}</td>
            <td style="padding: 15px;">
                {% if user.id != current_user.id %}
                <div style="display: flex; gap: 5px;">
                    <button onclick="clearUserBooks('{{ user.id }}', '{{ user.username }}')"
                            style="background: #fab1a0; color: #d63031; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer;">
                        üóëÔ∏è Clear Books
                    </button>
                    <button onclick="confirmDeleteUser('{{ user.id }}', '{{ user.username }}')"
                            style="background: #ff7675; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer;">
                        Delete User
                    </button>
                </div>
                {% else %}
                <span style="color: #636e72; font-style: italic;">(You)</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div id="confirm-modal" class="modal"
     style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 2000;">
    <div class="modal-content"
         style="max-width: 350px; text-align: center; background: #3d3d4e; color: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <p id="confirm-text" style="font-size: 1.1rem; line-height: 1.4;"></p>
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
            <button onclick="closeConfirm()"
                    style="background: #575766; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                Cancel
            </button>
            <button id="confirm-action-btn"
                    style="background: #ff7675; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                Confirm
            </button>
        </div>
    </div>
</div>

<script>
    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
    }

    function showAlert(text) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `<div class="alert-box" style="background:#ff7675; color:white; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: fadeIn 0.3s;">${text}</div>`;
        setTimeout(() => container.innerHTML = '', 4000);
    }

    function confirmDeleteUser(id, name) {
        const modal = document.getElementById('confirm-modal');
        const text = document.getElementById('confirm-text');
        const btn = document.getElementById('confirm-action-btn');

        text.innerText = `Are you sure you want to delete user "${name}" and all their data? This cannot be undone.`;
        btn.style.background = "#ff7675";
        btn.innerText = "Delete User";
        modal.style.display = 'flex';

        btn.onclick = async function () {
            try {
                const response = await fetch(`/api/admin/delete_user/${id}`, {method: 'DELETE'});
                const data = await response.json();
                if (data.success) {
                    document.getElementById(`user-row-${id}`).remove();
                    showAlert(`User ${name} deleted.`);
                } else {
                    showAlert(data.message);
                }
            } catch (e) {
                showAlert("Error deleting user.");
            }
            closeConfirm();
        };
    }

    function clearUserBooks(id, name) {
        const modal = document.getElementById('confirm-modal');
        const text = document.getElementById('confirm-text');
        const btn = document.getElementById('confirm-action-btn');

        text.innerText = `Delete ALL books belonging to "${name}"? The user account will remain.`;
        btn.style.background = "#fab1a0";
        btn.style.color = "#d63031";
        btn.innerText = "Clear Books";
        modal.style.display = 'flex';

        btn.onclick = async function () {
            try {
                const response = await fetch(`/api/admin/clear_books/${id}`, {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    document.getElementById(`books-count-${id}`).innerText = "0";
                    showAlert(`Books for ${name} have been cleared.`);
                } else {
                    showAlert("Failed to clear books.");
                }
            } catch (e) {
                showAlert("Error connecting to server.");
            }
            closeConfirm();
            btn.style.color = "white";
        };
    }
</script>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}