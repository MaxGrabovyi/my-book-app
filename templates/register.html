{% extends "base.html" %}
{% block content %}
<div class="auth-wrapper">
    <div class="auth-card">
        <h2>Create Secure Account</h2>

        <div id="alert-container"></div>

        <form id="registerForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="reg-username" name="username" minlength="3" required placeholder="User1234">
            </div>

            <div class="form-group">
                <label for="reg-email">Google Email</label>
                <input type="email" id="reg-email" name="email" placeholder="example@gmail.com" required>
                <small class="input-hint">Must be a valid @gmail.com address</small>
            </div>

            <div class="form-group">
                <label>Password</label>
                <div class="password-input">
                    <input type="password" name="password" id="mainPass"
                           placeholder="Min 8 chars, 1 digit, 1 caps, 1 lower" required>
                    <button type="button" class="toggle-pass" onclick="toggleVisibility('mainPass')">üëÅÔ∏è</button>
                </div>
            </div>

            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="confirmPass" required>
            </div>

            <button type="submit" class="submit-btn">Register & Protect</button>
        </form>
        <p class="auth-footer">Already have an account? <a href="/api/auth/login">Sign In</a></p>
    </div>
</div>

<script>
    function toggleVisibility(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }

    document.getElementById('registerForm').onsubmit = async function (e) {
        e.preventDefault();

        const username = document.getElementById('reg-username').value.trim();
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        const password = document.getElementById('mainPass').value;
        const confirm = document.getElementById('confirmPass').value;

        const hasLowerCase = /[a-z]/.test(password);
        const hasUpperCase = /[A-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        if (password !== confirm) {
            showAlert("Passwords do not match!");
            return;
        }

        if (!email.endsWith('@gmail.com')) {
            showAlert("Only @gmail.com addresses are allowed!");
            return;
        }

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    email: email,
                    password: password,
                    confirm_password: confirm
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                window.location.href = '/';
            } else {
                showAlert(data.message || "Registration failed");
            }
        } catch (error) {
            console.error("Error:", error);
            showAlert("Connection error. Please try again later.");
        }
    };

    function showAlert(text) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `<div class="alert-box" style="background:#ff7675; color:white; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        ${text}
    </div>`;

        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }
</script>
{% endblock %}